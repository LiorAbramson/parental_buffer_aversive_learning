---
title: "parental_buffer_analyses"
author: "Lior Abramson"
date: "March 2023"
output: html_document
---

1:: preliminary stuff

#house keeping:
```{r setup, include=FALSE}
  rm(list = ls())
  cat ("\014")
  if(is.null(dev.list()) == FALSE) dev.off()

#Packages
  packages <- c('reshape','psych','rstatix','tidyverse', 'Rmisc', 'lme4','ggpubr','report','gridExtra')
  lapply(packages, require, character.only = TRUE)

```

#load behavioral data:
```{r}
#load data
  D <- read.csv("../data/Class_cond_Behav_all_030422.csv")
```

#organize data:
```{r}
#arrange response vars (like+nervous questions)
  DBehav <-D[!is.na(D$LikePre.RESP)|!is.na(D$LikePost.RESP),] #take only rating trials
  
  DBehav$Like.RESP <- NA
  DBehav$Like.RESP[!is.na(DBehav$LikePre.RESP)]  <- DBehav$LikePre.RESP[!is.na(DBehav$LikePre.RESP)] 
  DBehav$Like.RESP[!is.na(DBehav$LikePost.RESP)] <- DBehav$LikePost.RESP[!is.na(DBehav$LikePost.RESP)]
  
  DBehav$Nervous.RESP <- NA
  DBehav$Nervous.RESP[!is.na(DBehav$NervousPre.RESP)]  <- DBehav$NervousPre.RESP[!is.na(DBehav$NervousPre.RESP)] 
  DBehav$Nervous.RESP[!is.na(DBehav$NervousPost.RESP)] <- DBehav$NervousPost.RESP[!is.na(DBehav$NervousPost.RESP)]

  DBehav$time <- NA
  DBehav$time[!is.na(DBehav$LikePre.RESP)]  <-"Pre"
  DBehav$time[!is.na(DBehav$LikePost.RESP)] <-"Post"
  DBehav$version_time_and_stim <- paste0(DBehav$Version,"_",DBehav$time,"_",DBehav$Shape)
  
#take only relevant vars 
  DBehav <- DBehav[,c("Subject","DataFile.Basename","Like.RESP","Nervous.RESP","version_time_and_stim")]
  
#remove version V1_REG of subject EL062  (a redundant, wrong file) 
  DBehav <- DBehav[!(DBehav$Subject==62 & DBehav$DataFile.Basename=="Class_cond_v1_REG-0062-1"),]

```

#add information about condition (parent/alone)
```{r}
#turn to wide format
#ignore warning message (it refers to a subject who is about to be removed from the file anyway)
  DBehav_Wide <- reshape(DBehav, timevar="version_time_and_stim",idvar="Subject", direction="wide")

#import condition data
  DParentInfo <- read.csv("../data/ClassCond_ParentConditionData.csv")
  DBehav_Wide <- merge(DBehav_Wide,DParentInfo[,c("Subject","Version_Parent","Version_Alone","First_Cond")], by="Subject", all.x=T, all.y=F)
```

#add demographic details:
```{r}
#import data
  DDemographics <- read.csv("../data/ELFK_demographics.csv")
  DBehav_Wide <- merge(DBehav_Wide,DDemographics[,c("Subject","SEX","MRI_AGE","DEM_4_RACE_CHILD","DEM_4_RACE_CHILD_OTHER")], by="Subject", all.x=T, all.y=F)
  
```

#exclude participants (from both long and wide dataframes) and check demographic characteristics of final sample 
```{r}
#remove children from the caregiving related early adversities group
  crEAsgroup <-c("6","60","97","98","99","101","102")
  for (i in crEAsgroup){DBehav <- DBehav[DBehav$Subject!=i,]}
  for (i in crEAsgroup){DBehav_Wide <- DBehav_Wide[DBehav_Wide$Subject!=i,]}
  
#check age, sex and race without them
  #age
  summary(DBehav_Wide$MRI_AGE) 
  sd(DBehav_Wide$MRI_AGE, na.rm=T) 
  #sex
  summary(as.factor(DBehav_Wide$SEX))
  #race
  summary(as.factor(DBehav_Wide$DEM_4_RACE_CHILD))
  

#remove subjects 76 and 80 (experimenter error- watched the same shapes in both parent and alone condition)
#remove subjects 24 and 88 (did not complete both conditions)
  DBehav <- DBehav[DBehav$Subject!=76 & DBehav$Subject!=80 & DBehav$Subject!=24 & DBehav$Subject!=88,]
  DBehav_Wide <- DBehav_Wide[DBehav_Wide$Subject!=76 & DBehav_Wide$Subject!=80 & DBehav_Wide$Subject!=24 & DBehav_Wide$Subject!=88,]

#check age, sex and race for the final behavioral sample
  #age
  summary(DBehav_Wide$MRI_AGE) 
  sd(DBehav_Wide$MRI_AGE, na.rm=T) 
  #sex
  summary(as.factor(DBehav_Wide$SEX))
  #race
  summary(as.factor(DBehav_Wide$DEM_4_RACE_CHILD))
  
```

#create raw scores for each condition in the wide format
```{r}
#like question
  DBehav_Wide$ParentPre_CSPlus <- NA
  DBehav_Wide$ParentPre_CSMinus <- NA
  DBehav_Wide$AlonePre_CSPlus <- NA
  DBehav_Wide$AlonePre_CSMinus <- NA
  
  DBehav_Wide$ParentPost_CSPlus <- NA
  DBehav_Wide$ParentPost_CSMinus <- NA
  DBehav_Wide$AlonePost_CSPlus <- NA
  DBehav_Wide$AlonePost_CSMinus <- NA
  
  DBehav_Wide$ParentPre_CSPlus[DBehav_Wide$Version_Parent=="V1"]   <-DBehav_Wide$Like.RESP.v1_Pre_CSPlus[DBehav_Wide$Version_Parent=="V1"]
  DBehav_Wide$ParentPre_CSPlus[DBehav_Wide$Version_Parent=="V2"]   <-DBehav_Wide$Like.RESP.v2_Pre_CSPlus[DBehav_Wide$Version_Parent=="V2"]
  DBehav_Wide$ParentPre_CSMinus[DBehav_Wide$Version_Parent=="V1"]  <-DBehav_Wide$Like.RESP.v1_Pre_CSMinus[DBehav_Wide$Version_Parent=="V1"]
  DBehav_Wide$ParentPre_CSMinus[DBehav_Wide$Version_Parent=="V2"]  <-DBehav_Wide$Like.RESP.v2_Pre_CSMinus[DBehav_Wide$Version_Parent=="V2"]
  DBehav_Wide$ParentPost_CSPlus[DBehav_Wide$Version_Parent=="V1"]  <-DBehav_Wide$Like.RESP.v1_Post_CSPlus[DBehav_Wide$Version_Parent=="V1"]
  DBehav_Wide$ParentPost_CSPlus[DBehav_Wide$Version_Parent=="V2"]  <-DBehav_Wide$Like.RESP.v2_Post_CSPlus[DBehav_Wide$Version_Parent=="V2"]
  DBehav_Wide$ParentPost_CSMinus[DBehav_Wide$Version_Parent=="V1"] <-DBehav_Wide$Like.RESP.v1_Post_CSMinus[DBehav_Wide$Version_Parent=="V1"]
  DBehav_Wide$ParentPost_CSMinus[DBehav_Wide$Version_Parent=="V2"] <-DBehav_Wide$Like.RESP.v2_Post_CSMinus[DBehav_Wide$Version_Parent=="V2"]
  
  DBehav_Wide$AlonePre_CSPlus[DBehav_Wide$Version_Alone=="V1"]   <-DBehav_Wide$Like.RESP.v1_Pre_CSPlus[DBehav_Wide$Version_Alone=="V1"]
  DBehav_Wide$AlonePre_CSPlus[DBehav_Wide$Version_Alone=="V2"]   <-DBehav_Wide$Like.RESP.v2_Pre_CSPlus[DBehav_Wide$Version_Alone=="V2"]
  DBehav_Wide$AlonePre_CSMinus[DBehav_Wide$Version_Alone=="V1"]  <-DBehav_Wide$Like.RESP.v1_Pre_CSMinus[DBehav_Wide$Version_Alone=="V1"]
  DBehav_Wide$AlonePre_CSMinus[DBehav_Wide$Version_Alone=="V2"]  <-DBehav_Wide$Like.RESP.v2_Pre_CSMinus[DBehav_Wide$Version_Alone=="V2"]
  DBehav_Wide$AlonePost_CSPlus[DBehav_Wide$Version_Alone=="V1"]  <-DBehav_Wide$Like.RESP.v1_Post_CSPlus[DBehav_Wide$Version_Alone=="V1"]
  DBehav_Wide$AlonePost_CSPlus[DBehav_Wide$Version_Alone=="V2"]  <-DBehav_Wide$Like.RESP.v2_Post_CSPlus[DBehav_Wide$Version_Alone=="V2"]
  DBehav_Wide$AlonePost_CSMinus[DBehav_Wide$Version_Alone=="V1"] <-DBehav_Wide$Like.RESP.v1_Post_CSMinus[DBehav_Wide$Version_Alone=="V1"]
  DBehav_Wide$AlonePost_CSMinus[DBehav_Wide$Version_Alone=="V2"] <-DBehav_Wide$Like.RESP.v2_Post_CSMinus[DBehav_Wide$Version_Alone=="V2"] 
  
#nervous question
  DBehav_Wide$ParentPre_CSPlus.ner <- NA
  DBehav_Wide$ParentPre_CSMinus.ner <- NA
  DBehav_Wide$AlonePre_CSPlus.ner <- NA
  DBehav_Wide$AlonePre_CSMinus.ner <- NA
  
  DBehav_Wide$ParentPost_CSPlus.ner <- NA
  DBehav_Wide$ParentPost_CSMinus.ner <- NA
  DBehav_Wide$AlonePost_CSPlus.ner <- NA
  DBehav_Wide$AlonePost_CSMinus.ner <- NA
  
  DBehav_Wide$ParentPre_CSPlus.ner[DBehav_Wide$Version_Parent=="V1"]   <-DBehav_Wide$Nervous.RESP.v1_Pre_CSPlus[DBehav_Wide$Version_Parent=="V1"]
  DBehav_Wide$ParentPre_CSPlus.ner[DBehav_Wide$Version_Parent=="V2"]   <-DBehav_Wide$Nervous.RESP.v2_Pre_CSPlus[DBehav_Wide$Version_Parent=="V2"]
  DBehav_Wide$ParentPre_CSMinus.ner[DBehav_Wide$Version_Parent=="V1"]  <-DBehav_Wide$Nervous.RESP.v1_Pre_CSMinus[DBehav_Wide$Version_Parent=="V1"]
  DBehav_Wide$ParentPre_CSMinus.ner[DBehav_Wide$Version_Parent=="V2"]  <-DBehav_Wide$Nervous.RESP.v2_Pre_CSMinus[DBehav_Wide$Version_Parent=="V2"]
  DBehav_Wide$ParentPost_CSPlus.ner[DBehav_Wide$Version_Parent=="V1"]  <-DBehav_Wide$Nervous.RESP.v1_Post_CSPlus[DBehav_Wide$Version_Parent=="V1"]
  DBehav_Wide$ParentPost_CSPlus.ner[DBehav_Wide$Version_Parent=="V2"]  <-DBehav_Wide$Nervous.RESP.v2_Post_CSPlus[DBehav_Wide$Version_Parent=="V2"]
  DBehav_Wide$ParentPost_CSMinus.ner[DBehav_Wide$Version_Parent=="V1"] <-DBehav_Wide$Nervous.RESP.v1_Post_CSMinus[DBehav_Wide$Version_Parent=="V1"]
  DBehav_Wide$ParentPost_CSMinus.ner[DBehav_Wide$Version_Parent=="V2"] <-DBehav_Wide$Nervous.RESP.v2_Post_CSMinus[DBehav_Wide$Version_Parent=="V2"]
  
  DBehav_Wide$AlonePre_CSPlus.ner[DBehav_Wide$Version_Alone=="V1"]   <-DBehav_Wide$Nervous.RESP.v1_Pre_CSPlus[DBehav_Wide$Version_Alone=="V1"]
  DBehav_Wide$AlonePre_CSPlus.ner[DBehav_Wide$Version_Alone=="V2"]   <-DBehav_Wide$Nervous.RESP.v2_Pre_CSPlus[DBehav_Wide$Version_Alone=="V2"]
  DBehav_Wide$AlonePre_CSMinus.ner[DBehav_Wide$Version_Alone=="V1"]  <-DBehav_Wide$Nervous.RESP.v1_Pre_CSMinus[DBehav_Wide$Version_Alone=="V1"]
  DBehav_Wide$AlonePre_CSMinus.ner[DBehav_Wide$Version_Alone=="V2"]  <-DBehav_Wide$Nervous.RESP.v2_Pre_CSMinus[DBehav_Wide$Version_Alone=="V2"]
  DBehav_Wide$AlonePost_CSPlus.ner[DBehav_Wide$Version_Alone=="V1"]  <-DBehav_Wide$Nervous.RESP.v1_Post_CSPlus[DBehav_Wide$Version_Alone=="V1"]
  DBehav_Wide$AlonePost_CSPlus.ner[DBehav_Wide$Version_Alone=="V2"]  <-DBehav_Wide$Nervous.RESP.v2_Post_CSPlus[DBehav_Wide$Version_Alone=="V2"]
  DBehav_Wide$AlonePost_CSMinus.ner[DBehav_Wide$Version_Alone=="V1"] <-DBehav_Wide$Nervous.RESP.v1_Post_CSMinus[DBehav_Wide$Version_Alone=="V1"]
  DBehav_Wide$AlonePost_CSMinus.ner[DBehav_Wide$Version_Alone=="V2"] <-DBehav_Wide$Nervous.RESP.v2_Post_CSMinus[DBehav_Wide$Version_Alone=="V2"]
```

#create difference scores- substract CS- from CS+ for pre and post ratings
```{r}
#first, create a variable for each run order (v1 and v2)
#like question
#a more positive score means that the CS+ was more liked than the CS-
  DBehav_Wide$v1_Pre_PlusMinMinus  <- DBehav_Wide$Like.RESP.v1_Pre_CSPlus - DBehav_Wide$Like.RESP.v1_Pre_CSMinus
  DBehav_Wide$v1_Post_PlusMinMinus <- DBehav_Wide$Like.RESP.v1_Post_CSPlus- DBehav_Wide$Like.RESP.v1_Post_CSMinus
  DBehav_Wide$v2_Pre_PlusMinMinus  <- DBehav_Wide$Like.RESP.v2_Pre_CSPlus - DBehav_Wide$Like.RESP.v2_Pre_CSMinus
  DBehav_Wide$v2_Post_PlusMinMinus <- DBehav_Wide$Like.RESP.v2_Post_CSPlus- DBehav_Wide$Like.RESP.v2_Post_CSMinus
  
#nervous question
#a more positive score means that the CS+ made participants more nervous than the CS-
  DBehav_Wide$v1_Pre_PlusMinMinus.ner  <- DBehav_Wide$Nervous.RESP.v1_Pre_CSPlus - DBehav_Wide$Nervous.RESP.v1_Pre_CSMinus
  DBehav_Wide$v1_Post_PlusMinMinus.ner <- DBehav_Wide$Nervous.RESP.v1_Post_CSPlus- DBehav_Wide$Nervous.RESP.v1_Post_CSMinus
  DBehav_Wide$v2_Pre_PlusMinMinus.ner  <- DBehav_Wide$Nervous.RESP.v2_Pre_CSPlus - DBehav_Wide$Nervous.RESP.v2_Pre_CSMinus
  DBehav_Wide$v2_Post_PlusMinMinus.ner <- DBehav_Wide$Nervous.RESP.v2_Post_CSPlus- DBehav_Wide$Nervous.RESP.v2_Post_CSMinus
  
#next, create difference score according to condition (parent vs. alone) 
  #Like question
  DBehav_Wide$Parent_Pre_PlusMinMinus <- NA
  DBehav_Wide$Alone_Pre_PlusMinMinus <- NA
  DBehav_Wide$Parent_Post_PlusMinMinus <- NA
  DBehav_Wide$Alone_Post_PlusMinMinus <- NA
  
  DBehav_Wide$Parent_Pre_PlusMinMinus[DBehav_Wide$Version_Parent=="V1"] <-DBehav_Wide$v1_Pre_PlusMinMinus[DBehav_Wide$Version_Parent=="V1"]
  DBehav_Wide$Parent_Pre_PlusMinMinus[DBehav_Wide$Version_Parent=="V2"] <-DBehav_Wide$v2_Pre_PlusMinMinus[DBehav_Wide$Version_Parent=="V2"]
  
  DBehav_Wide$Alone_Pre_PlusMinMinus[DBehav_Wide$Version_Alone=="V1"] <-DBehav_Wide$v1_Pre_PlusMinMinus[DBehav_Wide$Version_Alone=="V1"]
  DBehav_Wide$Alone_Pre_PlusMinMinus[DBehav_Wide$Version_Alone=="V2"] <-DBehav_Wide$v2_Pre_PlusMinMinus[DBehav_Wide$Version_Alone=="V2"]
  
  DBehav_Wide$Parent_Post_PlusMinMinus[DBehav_Wide$Version_Parent=="V1"] <-DBehav_Wide$v1_Post_PlusMinMinus[DBehav_Wide$Version_Parent=="V1"]
  DBehav_Wide$Parent_Post_PlusMinMinus[DBehav_Wide$Version_Parent=="V2"] <-DBehav_Wide$v2_Post_PlusMinMinus[DBehav_Wide$Version_Parent=="V2"]
  
  DBehav_Wide$Alone_Post_PlusMinMinus[DBehav_Wide$Version_Alone=="V1"] <-DBehav_Wide$v1_Post_PlusMinMinus[DBehav_Wide$Version_Alone=="V1"]
  DBehav_Wide$Alone_Post_PlusMinMinus[DBehav_Wide$Version_Alone=="V2"] <-DBehav_Wide$v2_Post_PlusMinMinus[DBehav_Wide$Version_Alone=="V2"]
  
  #Nervous question
  DBehav_Wide$Parent_Pre_PlusMinMinus.ner <- NA
  DBehav_Wide$Alone_Pre_PlusMinMinus.ner <- NA
  DBehav_Wide$Parent_Post_PlusMinMinus.ner <- NA
  DBehav_Wide$Alone_Post_PlusMinMinus.ner <- NA
  
  DBehav_Wide$Parent_Pre_PlusMinMinus.ner[DBehav_Wide$Version_Parent=="V1"] <-DBehav_Wide$v1_Pre_PlusMinMinus.ner[DBehav_Wide$Version_Parent=="V1"]
  DBehav_Wide$Parent_Pre_PlusMinMinus.ner[DBehav_Wide$Version_Parent=="V2"] <-DBehav_Wide$v2_Pre_PlusMinMinus.ner[DBehav_Wide$Version_Parent=="V2"]
  
  DBehav_Wide$Alone_Pre_PlusMinMinus.ner[DBehav_Wide$Version_Alone=="V1"] <-DBehav_Wide$v1_Pre_PlusMinMinus.ner[DBehav_Wide$Version_Alone=="V1"]
  DBehav_Wide$Alone_Pre_PlusMinMinus.ner[DBehav_Wide$Version_Alone=="V2"] <-DBehav_Wide$v2_Pre_PlusMinMinus.ner[DBehav_Wide$Version_Alone=="V2"]
  
  DBehav_Wide$Parent_Post_PlusMinMinus.ner[DBehav_Wide$Version_Parent=="V1"] <-DBehav_Wide$v1_Post_PlusMinMinus.ner[DBehav_Wide$Version_Parent=="V1"]
  DBehav_Wide$Parent_Post_PlusMinMinus.ner[DBehav_Wide$Version_Parent=="V2"] <-DBehav_Wide$v2_Post_PlusMinMinus.ner[DBehav_Wide$Version_Parent=="V2"]
  
  DBehav_Wide$Alone_Post_PlusMinMinus.ner[DBehav_Wide$Version_Alone=="V1"] <-DBehav_Wide$v1_Post_PlusMinMinus.ner[DBehav_Wide$Version_Alone=="V1"]
  DBehav_Wide$Alone_Post_PlusMinMinus.ner[DBehav_Wide$Version_Alone=="V2"] <-DBehav_Wide$v2_Post_PlusMinMinus.ner[DBehav_Wide$Version_Alone=="V2"]
  
```

#look at the variables' descriptive statistics
```{r}
#like question
  describe(DBehav_Wide[,c("ParentPre_CSMinus","ParentPost_CSMinus","ParentPre_CSPlus","ParentPost_CSPlus",
                          "AlonePre_CSMinus","AlonePost_CSMinus","AlonePre_CSPlus","AlonePost_CSPlus")])

#nervous question
  describe (DBehav_Wide[,c("ParentPre_CSMinus.ner","ParentPost_CSMinus.ner","ParentPre_CSPlus.ner","ParentPost_CSPlus.ner",
                           "AlonePre_CSMinus.ner","AlonePost_CSMinus.ner","AlonePre_CSPlus.ner","AlonePost_CSPlus.ner")])

#difference score-like question
  describe(DBehav_Wide[,c("Parent_Pre_PlusMinMinus","Parent_Post_PlusMinMinus",
                          "Alone_Pre_PlusMinMinus","Alone_Post_PlusMinMinus")])
  
#difference score-nervous question
  describe(DBehav_Wide[,c("Parent_Pre_PlusMinMinus.ner","Parent_Post_PlusMinMinus.ner",
                          "Alone_Pre_PlusMinMinus.ner","Alone_Post_PlusMinMinus.ner")])

```

#create a long format for the difference scores
```{r}
 DBehav_Longdif <- DBehav_Wide[,c("Subject",
                                  "Parent_Pre_PlusMinMinus","Parent_Post_PlusMinMinus",
                                  "Alone_Pre_PlusMinMinus","Alone_Post_PlusMinMinus",
                                  "Parent_Pre_PlusMinMinus.ner","Parent_Post_PlusMinMinus.ner",
                                  "Alone_Pre_PlusMinMinus.ner","Alone_Post_PlusMinMinus.ner")]

#change vars names
 colnames(DBehav_Longdif) <- gsub("_PlusMinMinus","",colnames(DBehav_Longdif))
 colnames(DBehav_Longdif) <- gsub("_","",colnames(DBehav_Longdif))
 col <- colnames(DBehav_Longdif)
 colnames(DBehav_Longdif)[c(which(col=="ParentPre.ner"),which(col=="ParentPost.ner"),which(col=="AlonePre.ner"),which(col=="AlonePost.ner"))] <-
                          c("NervousRESP_ParentPre","NervousRESP_ParentPost","NervousRESP_AlonePre","NervousRESP_AlonePost")
 colnames(DBehav_Longdif)[c(which(col=="ParentPre"),which(col=="ParentPost"), which(col=="AlonePre"),which(col=="AlonePost"))] <-
                          c("LikeRESP_ParentPre","LikeRESP_ParentPost","LikeRESP_AlonePre","LikeRESP_AlonePost")
 
#turn to long format 
 DBehav_Longdif <- reshape(DBehav_Longdif,idvar="Subject", timevar = "versiontime",
                                varying=colnames(DBehav_Longdif)[2:9],direction="long", sep="_")
  
 DBehav_Longdif$version <-NA
 DBehav_Longdif$version[DBehav_Longdif$versiontime=="ParentPre"|DBehav_Longdif$versiontime=="ParentPost"] <- "Parent"
 DBehav_Longdif$version[DBehav_Longdif$versiontime=="AlonePre"|DBehav_Longdif$versiontime=="AlonePost"] <- "Alone"
  
 DBehav_Longdif$time <-NA
 DBehav_Longdif$time[DBehav_Longdif$versiontime=="ParentPre"| DBehav_Longdif$versiontime=="AlonePre"] <- "1Pre"
 DBehav_Longdif$time[DBehav_Longdif$versiontime=="ParentPost"| DBehav_Longdif$versiontime=="AlonePost"] <- "2Post"
 
#verify that means stay the same after reshaping
 describeBy(data=DBehav_Longdif, LikeRESP ~ time+version)  
 describeBy(data=DBehav_Longdif, NervousRESP ~ time+version)
#all good
  
```

#create a long format of parent/alone information to attach to fMRI data
```{r}
DParentOrderLong <- DParentInfo[,c("Subject","Scan_Parent","Scan_Alone")]
DParentOrderLong <- reshape(DParentOrderLong, idvar="Subject", timevar="Parent_Alone", 
                             varying=colnames(DParentOrderLong)[2:3],direction="long",sep="_")
colnames(DParentOrderLong)[colnames(DParentOrderLong)=="Scan"] <- "order"
  
```


2:: Behavioral analyses
#statistical test- like question
```{r}

#add sex, age and order information
colnames(DBehav_Longdif)[which(colnames(DBehav_Longdif)=="version")] <- "Parent_Alone"

DBehav_Longdif <- merge(DBehav_Longdif,DBehav_Wide[,c("Subject","SEX","MRI_AGE")],
                              by="Subject", all.x=T, all.y=F)
#attach parent-alone information
  DBehav_Longdif <- merge(DBehav_Longdif, DParentOrderLong, by=c("Subject","Parent_Alone"), all.x=T, all.y=F)
  
colnames(DBehav_Longdif)[which(colnames(DBehav_Longdif)=="Parent_Alone")] <- "version"

#center variables
  DBehav_Longdif <- DBehav_Longdif %>%
    dplyr::mutate(SEX_num = ifelse(SEX=="m",0,1),
                  SEX_num_c = scale(SEX_num,scale=F),
                  version_num = ifelse(version=="Alone",0,1),
                  version_num_c = scale(version_num,scale=F),
                  time_num = ifelse(time=="1Pre",0,1),
                  time_num_c = scale(time_num,scale=F),
                  order_num = ifelse(order=="cond1",0,1),
                  order_num_c = scale(order_num,scale=F),
                  MRI_AGE_c = scale(MRI_AGE, scale=F))
   
  model_like <-lmer(data= DBehav_Longdif, LikeRESP~version_num_c*time_num_c+(1|Subject))
  report(model_like)
  
  #with confounds
  model_like_confounds <-lmer(data= DBehav_Longdif, LikeRESP~ 
                                version_num_c*time_num_c +
                                SEX_num_c+MRI_AGE_c + (1|Subject))
  report(model_like_confounds)

#visualization
#a) summarize overall group effects by condition
  sum_like_dif_se <- summarySE(data = DBehav_Longdif, measurevar="LikeRESP", groupvars =c("version","time"),
             na.rm = T, conf.interval = 0.95,.drop = TRUE)
  
#b) plot
  LikeRESP_plot <- ggplot(data = as.data.frame(sum_like_dif_se), aes(x = time, y = LikeRESP, group=version, colour = version)) + 
    geom_path(alpha = 0.2, size = 0.2) +
    geom_errorbar(aes(ymin=LikeRESP-se, ymax=LikeRESP+se), width=.1, position=position_dodge(0.05)) +
    geom_line(aes(x = time, y = LikeRESP,color = version), size = 2.5) +
    labs (x = "time", y = "Like rating difference (CS+ > CS-) ") +
    scale_x_discrete(labels=c("Pre-conditioning", "Post-conditioning")) +
    ylim(-1, 1) +
    theme_classic() +
    scale_color_brewer(palette="Set2", labels = c("Absent", "Present")) +
    scale_linetype_manual(values=c("dashed", "solid")) +
    theme(axis.text = element_text(size = 25) , axis.title = element_text(size = 25))
  LikeRESP_plot
  
```

#statistical test- nervous question
```{r}

#remove nervous data of subject 56 from the alone condition (was not asked this question in the parent condition due to experimenter error)
DBehav_Longdif$NervousRESP[DBehav_Longdif$Subject==56] <- NA
DBehav_Wide$Alone_Pre_PlusMinMinus.ner[DBehav_Wide$Subject==56] <- NA
DBehav_Wide$Alone_Post_PlusMinMinus.ner[DBehav_Wide$Subject==56] <- NA

model_nervous <-lmer(data= DBehav_Longdif, NervousRESP~version_num_c*time_num_c+(1|Subject))
report(model_nervous)
  
#with confounds
model_nervous_confounds <-lmer(data= DBehav_Longdif, NervousRESP~ 
                                version_num_c*time_num_c +
                                SEX_num_c+MRI_AGE_c+ (1|Subject))
report(model_nervous_confounds)

#report on means for time regardless of condition 
#a) summarize overall group effects by condition
  sum_nervous_dif_se <- summarySE(data = DBehav_Longdif, measurevar="NervousRESP", groupvars =c("time"),
             na.rm = T, conf.interval = 0.95,.drop = TRUE)

#visualization
#a) summarize overall group effects by condition
  sum_nervous_dif_se <- summarySE(data = DBehav_Longdif, measurevar="NervousRESP", groupvars =c("version","time"),
             na.rm = T, conf.interval = 0.95,.drop = TRUE)
  
#b) plot
  NervousRESP_plot <- ggplot(data = as.data.frame(sum_nervous_dif_se), aes(x = time, y = NervousRESP, group=version, colour = version)) + 
    geom_path(alpha = 0.2, size = 0.2) +
    geom_errorbar(aes(ymin=NervousRESP-se, ymax=NervousRESP+se), width=.1, position=position_dodge(0.05)) +
    geom_line(aes(x = time, y = NervousRESP,color = version), size = 2.5) +
    labs (x = "time", y = "Nervousness rating difference (CS+ > CS-) ") +
    scale_x_discrete(labels=c("Pre-conditioning", "Post-conditioning")) +
    ylim(-1, 1) +
    theme_classic() +
    scale_color_brewer(palette="Set2", labels = c("Absent", "Present")) +
    scale_linetype_manual(values=c("dashed", "solid")) +
    theme(axis.text = element_text(size = 25) , axis.title = element_text(size = 25))
  NervousRESP_plot
```


3:: Neural results
#organize file-mPFC
```{r}
#condition 1
DROI_mPFC_cond1 <- read.csv ("../data/ROI_talairach_BA102432_-10-20_resampled_NL6Asym_cond1.csv")
valid_subj <- read.csv ("../data/valid_participant_list.csv")
DROI_mPFC_cond1$Subject <- rep(valid_subj$Subject, each=2)
DROI_mPFC_cond1$Subject <- as.numeric(gsub("sub-","",DROI_mPFC_cond1$Subject))
DROI_mPFC_cond1$contrast <- rep(c("noise_baseline","plus_minus"),times=nrow(valid_subj))
DROI_mPFC_cond1 <- reshape(DROI_mPFC_cond1, timevar="contrast",idvar="Subject", direction="wide")
DROI_mPFC_cond1$order <- "cond1"

#condition 2
DROI_mPFC_cond2 <- read.csv ("../data/ROI_talairach_BA102432_-10-20_resampled_NL6Asym_cond2.csv")
DROI_mPFC_cond2$Subject <- rep(valid_subj$Subject, each=2)
DROI_mPFC_cond2$Subject <- as.numeric(gsub("sub-","",DROI_mPFC_cond2$Subject))
DROI_mPFC_cond2$contrast <- rep(c("noise_baseline","plus_minus"),times=nrow(valid_subj))
DROI_mPFC_cond2 <- reshape(DROI_mPFC_cond2, timevar="contrast",idvar="Subject", direction="wide")
DROI_mPFC_cond2$order <- "cond2"

#combine conditions
DROI_mPFC <- rbind(DROI_mPFC_cond1,DROI_mPFC_cond2)

#merge with parent/alone version
DROI_mPFC <- merge(DROI_mPFC,DParentOrderLong, by=c("Subject","order"), all.x=T, all.y=F)

#merge with sex and age
 DROI_mPFC <- merge(DROI_mPFC,DBehav_Wide[,c("Subject","SEX","MRI_AGE")],
                              by="Subject", all.x=T, all.y=F)
 
#turn to numeric and scale
#create age groups- divide the sample according to children (under 11) and adolescents (age cutoff according to gee 2014)
 DROI_mPFC <- DROI_mPFC %>%
    dplyr::mutate(SEX_num = ifelse(SEX=="m",0,1),
                  SEX_num_c = scale(SEX_num,scale=F),
                  Parent_Alone_num = ifelse(Parent_Alone=="Alone",0,1),
                  Parent_Alone_num_c = scale(Parent_Alone_num,scale=F),
                  MRI_AGE_c = scale(MRI_AGE, scale=F),
                  MRI_AGE_group = ifelse(MRI_AGE<11,"child","adolescent"),
                  order_num = ifelse(order=="cond1",0,1),
                  order_num_c = scale(order_num, scale=F))

```

#report age and sex for final fMRI sample
```{r}
#age
  describe(DROI_mPFC$MRI_AGE[DROI_mPFC$Parent_Alone=="Parent"]) #choose only one row per subject (doesn't matter which)
#sex
  summary(as.factor(DROI_mPFC$SEX[DROI_mPFC$Parent_Alone=="Parent"]))
```

#test results- mPFC: US vs. baseline contrast
```{r, include=F}
#look at the descriptive statistics
describeBy (data= DROI_mPFC, mPFC_activation.noise_baseline~Parent_Alone)

#analysis without confounding variables
lmer_mPFC_noise_baseline<-lmer(data= DROI_mPFC, mPFC_activation.noise_baseline~Parent_Alone_num_c+(1|Subject))
report(lmer_mPFC_noise_baseline)

#analysis with two-way interactions of confounding variables
lmer_mPFC_noise_baseline_confounds <- lmer(data=DROI_mPFC, mPFC_activation.noise_baseline~
                                             Parent_Alone_num_c*SEX_num_c +
                                             Parent_Alone_num_c*MRI_AGE_c + (1|Subject))
report(lmer_mPFC_noise_baseline_confounds)

#create a wide format 
DROI_mPFC_wide <- reshape(DROI_mPFC, timevar="Parent_Alone",idvar="Subject", direction="wide")

#see how many show decrease and how many show increase
DROI_mPFC_wide <- DROI_mPFC_wide %>%
  mutate(trend_mPFC_noise = ifelse(mPFC_activation.noise_baseline.Parent>mPFC_activation.noise_baseline.Alone,1,
                        ifelse(mPFC_activation.noise_baseline.Parent<mPFC_activation.noise_baseline.Alone,-1,NA)),
         )

DROI_mPFC <- merge(DROI_mPFC,DROI_mPFC_wide[,c("Subject","trend_mPFC_noise")],
                              by="Subject", all.x=T, all.y=F)
  
summary(as.factor(DROI_mPFC_wide$trend_mPFC_noise[DROI_mPFC_wide$SEX.Alone=="f"]))
summary(as.factor(DROI_mPFC_wide$trend_mPFC_noise[DROI_mPFC_wide$SEX.Alone=="m"]))


plot_mPFC_noise_females <- ggplot(data = DROI_mPFC[DROI_mPFC$SEX=="f",], 
                               aes(group=interaction(Subject,trend_mPFC_noise), x=Parent_Alone,y = mPFC_activation.noise_baseline, color=as.factor(trend_mPFC_noise)))+
  geom_line(aes(group=interaction(Subject,trend_mPFC_noise), x=Parent_Alone,y=mPFC_activation.noise_baseline, color=as.factor(trend_mPFC_noise)), size=1)+
   stat_summary(fun=mean,geom="line",lwd=2,color="black",aes(group=1))+
  scale_color_brewer(palette="Set2")+
  theme_classic() +
  labs (x = "", y = "Activation (US vs. baseline)", title="Females")+
  theme(axis.text = element_text(size = 40) , axis.title = element_text(size = 40))+
  theme(legend.position="none", plot.title = element_text(hjust = 0.5, size=50))+
  scale_x_discrete(expand = expansion(mult=c(0.2,0.2)))+
  scale_y_continuous(limits = c(-1.2, 1.5), breaks = seq(-1,1.5,.5)) 


plot_mPFC_noise_males <- ggplot(data = DROI_mPFC[DROI_mPFC$SEX=="m",], 
                               aes(group=interaction(Subject,trend_mPFC_noise), x=Parent_Alone,y = mPFC_activation.noise_baseline, color=as.factor(trend_mPFC_noise)))+
  geom_line(aes(group=interaction(Subject,trend_mPFC_noise), x=Parent_Alone,y=mPFC_activation.noise_baseline, color=as.factor(trend_mPFC_noise)), size=1)+
   stat_summary(fun=mean,geom="line",lwd=2,color="black",aes(group=1))+
  scale_color_brewer(palette="Set2")+
  theme_classic() +
  labs (x = "", y = "", title="Males")+
  theme(axis.text = element_text(size = 40) , axis.title = element_text(size = 40))+
  theme(legend.position="none", plot.title = element_text(hjust = 0.5, size=50))+
  scale_x_discrete(expand = expansion(mult=c(0.2,0.2)))+
  scale_y_continuous(limits = c(-1.2, 1.5), breaks = seq(-1,1.5,.5)) 

grid.arrange(plot_mPFC_noise_females,plot_mPFC_noise_males, ncol=2,top="")



#spagehti plots without colored trends
plot_mPFC_noise_females <- ggplot(data = DROI_mPFC[DROI_mPFC$SEX=="f",], 
                               aes(group=Subject, x = Parent_Alone,y = mPFC_activation.noise_baseline, color=Parent_Alone))+
  geom_jitter(width = 0.05, alpha = 0.3) +
  geom_line(alpha = 0.2, size = 0.4, color="black")+
   stat_summary(fun=mean,geom="line",lwd=1,color="black",aes(group=1))+
  scale_color_brewer(palette="Set2")+
  theme_classic() +
  labs (x = "Parental context", y = "mPFC activation (US > baseline)")+
  theme(axis.text = element_text(size = 25) , axis.title = element_text(size = 25))+
  scale_x_discrete(expand = expansion(mult=c(0.3,2)))

plot_mPFC_noise_males <- ggplot(data = DROI_mPFC[DROI_mPFC$SEX=="",], 
                               aes(group=Subject, x = Parent_Alone,y = mPFC_activation.noise_baseline, color=Parent_Alone))+
  geom_jitter(width = 0.05, alpha = 0.3) +
  geom_line(alpha = 0.2, size = 0.4, color="black")+
   stat_summary(fun=mean,geom="line",lwd=1,color="black",aes(group=1))+
  scale_color_brewer(palette="Set2")+
  theme_classic() +
  labs (x = "Parental context", y = "mPFC activation (US > baseline)")+
  theme(axis.text = element_text(size = 25) , axis.title = element_text(size = 25))+
  scale_x_discrete(expand = expansion(mult=c(0.3,2)))


##visualize parentXsex results- no individual lines
sum_mPFC_se <- summarySE(data = DROI_mPFC, measurevar="mPFC_activation.noise_baseline", groupvars =c("Parent_Alone", "SEX"),
             na.rm = T, conf.interval = 0.95,.drop = TRUE)

mPFC_plot_average <- ggplot(data = sum_mPFC_se, 
                               aes(x = Parent_Alone,y = mPFC_activation.noise_baseline, group=SEX, color= SEX)) +
  geom_errorbar(aes(ymin=mPFC_activation.noise_baseline-se, ymax=mPFC_activation.noise_baseline+se), width=.1, position=position_dodge(0.05)) + 
  scale_color_brewer(palette="Set2")+
  stat_summary(fun=mean,geom="line",lwd=3,aes(group=SEX))+
  scale_y_continuous(limits = c(-.5, .5), breaks = seq(-.5,.5,.1)) + 
  theme_classic()+
  labs (x = "", y = "")+
  theme(legend.position="none", axis.text = element_text(size = 25) , axis.title = element_text(size = 25))+
  scale_x_discrete(expand = expansion(mult=c(0.3,0.3)))

```

#test results- mPFC: CS+ vs. CS- contrast
```{r}
#check plus vs minus contrast
describeBy (data= DROI_mPFC, mPFC_activation.plus_minus~Parent_Alone)

#analysis with no confounding variables
lmer_mPFC_plus_minus<-lmer(data= DROI_mPFC, mPFC_activation.plus_minus~Parent_Alone_num_c+(1|Subject))
report(lmer_mPFC_plus_minus)

#analysis with two-way interactions of confounding variables
lmer_mPFC_plus_minus_confounds <- lmer(data=DROI_mPFC, mPFC_activation.plus_minus~
                                             Parent_Alone_num_c*SEX_num_c +
                                             Parent_Alone_num_c*MRI_AGE_c +(1|Subject))
report(lmer_mPFC_plus_minus_confounds)

#see how many show decrease and how many show increase
DROI_mPFC_wide <- DROI_mPFC_wide %>%
  mutate(trend_mPFC_plusmin = ifelse(mPFC_activation.plus_minus.Parent>mPFC_activation.plus_minus.Alone,1,
                        ifelse(mPFC_activation.plus_minus.Parent<mPFC_activation.plus_minus.Alone,-1,NA)),
         )

DROI_mPFC <- merge(DROI_mPFC,DROI_mPFC_wide[,c("Subject","trend_mPFC_plusmin")],
                              by="Subject", all.x=T, all.y=F)
  

#visualize results with colored trends
plot_mPFC_plusmin <- ggplot(data = DROI_mPFC, 
                               aes(group=interaction(Subject,trend_mPFC_plusmin), x=Parent_Alone,y = mPFC_activation.plus_minus, color=as.factor(trend_mPFC_plusmin)))+
  geom_line(aes(group=interaction(Subject,trend_mPFC_plusmin), x=Parent_Alone,y=mPFC_activation.plus_minus, color=as.factor(trend_mPFC_plusmin)), size=1)+
   stat_summary(fun=mean,geom="line",lwd=2,color="black",aes(group=1))+
  scale_color_brewer(palette="Set2")+
  theme_classic() +
  labs (x = "", y = "Activation (CS+ vs. CS-)", title="")+
  theme(axis.text = element_text(size = 40) , axis.title = element_text(size = 40))+
  theme(legend.position="none", plot.title = element_text(hjust = 0.5, size=50))+
  scale_x_discrete(expand = expansion(mult=c(0.4,2)), labels=c("absence", "presence"))+
  scale_y_continuous(limits = c(-1.2, 1.2), breaks = seq(-1,1,.5)) 


#visualize results
plot_mPFC_plusmin <- ggplot(data = DROI_mPFC, 
                               aes(group=Subject, x = Parent_Alone,y = mPFC_activation.plus_minus, color=Parent_Alone))+
  geom_jitter(width = 0.05, alpha = 0.3) +
  geom_line(alpha = 0.2, size = 0.4, color="black")+
   stat_summary(fun=mean,geom="line",lwd=1,color="black",aes(group=1))+
  scale_color_brewer(palette="Set2")+
  theme_classic() +
  labs (x = "Parental context", y = "mPFC activation (CS+ > CS-) ")+
  theme(axis.text = element_text(size = 25) , axis.title = element_text(size = 25))+
  scale_x_discrete(expand = expansion(mult=c(0.3,2)))


#see how many show reduce and how many show increase
DROI_mPFC_wide <- DROI_mPFC_wide %>%
  mutate(trend_mPFC_plusmin = ifelse(mPFC_activation.plus_minus.Parent>mPFC_activation.plus_minus.Alone,1,
                        ifelse(mPFC_activation.plus_minus.Parent<mPFC_activation.plus_minus.Alone,-1,NA)),
         )
  
summary(as.factor(DROI_mPFC_wide$trend_mPFC_plusmin))

#visualize with individual lines but no colors
plot_mPFC_plusmin <- ggplot(data = DROI_mPFC, 
                               aes(group=Subject, x = Parent_Alone,y = mPFC_activation.plus_minus))+
  #geom_jitter(width = 0.05, alpha = 0.3) +
  geom_line(alpha = 0.2, size = 0.4, color="black")+
   stat_summary(fun=mean,geom="line",lwd=1,color="black",aes(group=1))+
 # geom_errorbar(aes(ymin=mPFC_activation.plus_minus-se, ymax=mPFC_activation.plus_minus+se), width=.1, position=position_dodge(0.05))+
  theme_classic() +
  labs (x = "Parental context", y = "BOLD activation (CS+ vs. CS-) ")+
  theme(axis.text = element_text(size = 25) , axis.title = element_text(size = 25))+
  scale_x_discrete(expand = expansion(mult=c(0.3,2)))

```

#organize file- amygala bilateral subnuclei 
#(change the data file each time to the nucleus mask you want to check)
```{r}
#contrast 1
  DROI_amyg_cond1 <- read.csv ("../data/ROI_juelich_thr60_lbamyg_bilateral_resample_NL6Asym_cond1.csv")
  valid_subj <- read.csv ("../data/valid_participant_list.csv")
  DROI_amyg_cond1$Subject <- rep(valid_subj$Subject, each=2)
  DROI_amyg_cond1$Subject <- as.numeric(gsub("sub-","",DROI_amyg_cond1$Subject))
  DROI_amyg_cond1$contrast <- rep(c("noise_baseline","plus_minus"),times=nrow(valid_subj))
  DROI_amyg_cond1 <- reshape(DROI_amyg_cond1, timevar="contrast",idvar="Subject", direction="wide")
  DROI_amyg_cond1$order <- "cond1"

#contrast 2
  DROI_amyg_cond2 <- read.csv ("../data/ROI_juelich_thr60_lbamyg_bilateral_resample_NL6Asym_cond2.csv")
  DROI_amyg_cond2$Subject <- rep(valid_subj$Subject, each=2)
  DROI_amyg_cond2$Subject <- as.numeric(gsub("sub-","",DROI_amyg_cond2$Subject))
  DROI_amyg_cond2$contrast <- rep(c("noise_baseline","plus_minus"),times=nrow(valid_subj))
  DROI_amyg_cond2 <- reshape(DROI_amyg_cond2, timevar="contrast",idvar="Subject", direction="wide")
  DROI_amyg_cond2$order <- "cond2"

#combine conditions
  DROI_amyg <- rbind(DROI_amyg_cond1,DROI_amyg_cond2)

#merge with parent/alone version
  DROI_amyg <- merge(DROI_amyg,DParentOrderLong, by=c("Subject","order"), all.x=T, all.y=F)

#merge with sex and age
  DROI_amyg <- merge(DROI_amyg,DBehav_Wide[,c("Subject","SEX","MRI_AGE")],
                              by="Subject", all.x=T, all.y=F)
 
#turn to numeric and scale
#create age groups- divide the sample according to children (under 11) and adolescents (age cutoff according to gee 2014)
   DROI_amyg <- DROI_amyg %>%
    dplyr::mutate(SEX_num = ifelse(SEX=="m",0,1),
                  SEX_num_c = scale(SEX_num,scale=F),
                  Parent_Alone_num = ifelse(Parent_Alone=="Alone",0,1),
                  Parent_Alone_num_c = scale(Parent_Alone_num,scale=F),
                  MRI_AGE_c = scale(MRI_AGE, scale=F),
                  MRI_AGE_group = ifelse(MRI_AGE<11,"child","adolescent"),
                  order_num = ifelse(order=="cond1",0,1),
                  order_num_c = scale(order_num,scale=F))

```

#test results amygdala bilateral subnuclei: US vs. baseline contrast 
```{r}
#look at the descriptive statistics
describeBy (data= DROI_amyg, amyg_activation.noise_baseline~Parent_Alone)

#analysis with no confounding variables
lmer_amyg_noise_baseline<-lmer(data= DROI_amyg, amyg_activation.noise_baseline~Parent_Alone_num_c+(1|Subject))
report(lmer_amyg_noise_baseline)

#analysis with two-way interactions of confounding variables
lmer_amyg_noise_baseline_confounds <- lmer(data=DROI_amyg, amyg_activation.noise_baseline~
                                             Parent_Alone_num_c*SEX_num_c +
                                             Parent_Alone_num_c*MRI_AGE_c +(1|Subject))
report(lmer_amyg_noise_baseline_confounds)

#examine separately for males and females
  describe(data = DROI_amyg, amyg_activation.noise_baseline~SEX*Parent_Alone)
  
  lmer_amyg_noise_baseline_males <-lmer(data= DROI_amyg[DROI_amyg$SEX=="m",], amyg_activation.noise_baseline~Parent_Alone_num_c + (1|Subject))
  report(lmer_amyg_noise_baseline_males)
  
  lmer_amyg_noise_baseline_females <-lmer(data= DROI_amyg[DROI_amyg$SEX=="f",], amyg_activation.noise_baseline~Parent_Alone_num_c + (1|Subject))
  report(lmer_amyg_noise_baseline_females)

#create a wide format 
DROI_amyg_wide <- reshape(DROI_amyg, timevar="Parent_Alone",idvar="Subject", direction="wide")

#see how many show decrease and how many show increase
DROI_amyg_wide <- DROI_amyg_wide %>%
  mutate(trend_amyg_noise = ifelse(amyg_activation.noise_baseline.Parent>amyg_activation.noise_baseline.Alone,1,
                        ifelse(amyg_activation.noise_baseline.Parent<amyg_activation.noise_baseline.Alone,-1,NA)),
         )

DROI_amyg <- merge(DROI_amyg,DROI_amyg_wide[,c("Subject","trend_amyg_noise")],
                              by="Subject", all.x=T, all.y=F)
  
summary(as.factor(DROI_amyg_wide$trend_amyg_noise))

#visualize results with colored trends
plot_amyg_noise <- ggplot(data = DROI_amyg, 
                               aes(group=interaction(Subject,trend_amyg_noise), x=Parent_Alone,y = amyg_activation.noise_baseline, color=as.factor(trend_amyg_noise)))+
  geom_line(aes(group=interaction(Subject,trend_amyg_noise), x=Parent_Alone,y=amyg_activation.noise_baseline, color=as.factor(trend_amyg_noise)), size=1)+
   stat_summary(fun=mean,geom="line",lwd=2,color="black",aes(group=1))+
  scale_color_brewer(palette="Set2")+
  theme_classic() +
  labs (x = "", y = "Activation (US vs. baseline)", title="")+
  theme(axis.text = element_text(size = 40) , axis.title = element_text(size = 40))+
  theme(legend.position="none", plot.title = element_text(hjust = 0.5, size=50))+
  scale_x_discrete(expand = expansion(mult=c(0.4,2)), labels=c("absence", "presence"))+
  scale_y_continuous(limits = c(-1.2, 1.2), breaks = seq(-1,1,.5)) 

#visualize results- no colored trends
sum_amyg_se <- summarySE(data = DROI_amyg, measurevar="amyg_activation.noise_baseline", groupvars =c("Parent_Alone"),
             na.rm = T, conf.interval = 0.95,.drop = TRUE)

```

#test results amygdala bilateral subnuclei: CS+ vs. CS- contrast 
```{r}
#check plus vs minus contrast
#look at the descriptive statistics
describeBy (data= DROI_amyg, amyg_activation.plus_minus~Parent_Alone)

#analysis with no confounding variables
lmer_amyg_plus_minus<-lmer(data= DROI_amyg, amyg_activation.plus_minus~Parent_Alone_num_c+(1|Subject))
report(lmer_amyg_plus_minus)

#analysis with two-way interactions of confounding variables
lmer_amyg_plus_minus_confounds <- lmer(data=DROI_amyg, amyg_activation.plus_minus~
                                             Parent_Alone_num_c*SEX_num_c +
                                             Parent_Alone_num_c*MRI_AGE_c + (1|Subject))
report(lmer_amyg_plus_minus_confounds)

#examine separately for males and females
  lmer_amyg_plus_minus_males <-lmer(data= DROI_amyg[DROI_amyg$SEX=="m",], 
                                    amyg_activation.plus_minus~Parent_Alone_num_c + (1|Subject))
  report(lmer_amyg_plus_minus_males)
  
  lmer_amyg_plus_minus_females <-lmer(data= DROI_amyg[DROI_amyg$SEX=="f",], 
                                      amyg_activation.plus_minus~Parent_Alone_num_c + (1|Subject))
  report(lmer_amyg_plus_minus_females)
```

#make a table for reporting on lmer results with confounding vars
#change the first two lines each time to the lmer model you want to print
```{r}
report_lmer <- as.data.frame(report(lmer_amyg_plus_minus_confounds))
sum_lmer <- summary(lmer_amyg_plus_minus_confounds)

lmer_table <- as.data.frame (matrix(nrow=9,ncol=2))
colnames(lmer_table) <- c("effect","report")
lmer_table$effect <- c("total R2","Fixed R2","random variance","Fixed intercept","Sex","Age","Parental context",
                       "Parental context X Sex", "Parental context X Age")

lmer_table[1,2] <- round(report_lmer$Fit[which(report_lmer$Parameter=="R2 (conditional)")],2)
lmer_table[2,2] <- round(report_lmer$Fit[which(report_lmer$Parameter=="R2 (marginal)")],2)
lmer_table[3,2] <- round(as.numeric(sum_lmer$varcor[1]),2)

lmer_table[4,2] <- paste0("b=",round(report_lmer$Coefficient[which(report_lmer$Parameter=="(Intercept)")],2)," [",
round(report_lmer$CI_low[which(report_lmer$Parameter=="(Intercept)")],2), ",",
round(report_lmer$CI_high[which(report_lmer$Parameter=="(Intercept)")],2),"], ", "t(",
report_lmer$df_error[1],")=",round(report_lmer$t[which(report_lmer$Parameter=="(Intercept)")],2),", p=",
round(report_lmer$p[which(report_lmer$Parameter=="(Intercept)")],3))

lmer_table[5,2] <- paste0("b=",round(report_lmer$Coefficient[which(report_lmer$Parameter=="SEX num c")],2)," [",
round(report_lmer$CI_low[which(report_lmer$Parameter=="SEX num c")],2), ",",
round(report_lmer$CI_high[which(report_lmer$Parameter=="SEX num c")],2),"], ",
"B=",round(report_lmer$Std_Coefficient[which(report_lmer$Parameter=="SEX num c")],2)," [",
round(report_lmer$Std_Coefficient_CI_low[which(report_lmer$Parameter=="SEX num c")],2), ",",
round(report_lmer$Std_Coefficient_CI_high[which(report_lmer$Parameter=="SEX num c")],2),"], t(",
report_lmer$df_error[1],")=",round(report_lmer$t[which(report_lmer$Parameter=="SEX num c")],2),", p=",
round(report_lmer$p[which(report_lmer$Parameter=="SEX num c")],3))

lmer_table[6,2] <- paste0("b=",round(report_lmer$Coefficient[which(report_lmer$Parameter=="MRI AGE c")],2)," [",
round(report_lmer$CI_low[which(report_lmer$Parameter=="MRI AGE c")],2), ",",
round(report_lmer$CI_high[which(report_lmer$Parameter=="MRI AGE c")],2),"], ",
"B=",round(report_lmer$Std_Coefficient[which(report_lmer$Parameter=="MRI AGE c")],2)," [",
round(report_lmer$Std_Coefficient_CI_low[which(report_lmer$Parameter=="MRI AGE c")],2), ",",
round(report_lmer$Std_Coefficient_CI_high[which(report_lmer$Parameter=="MRI AGE c")],2),"], t(",
report_lmer$df_error[1],")=",round(report_lmer$t[which(report_lmer$Parameter=="MRI AGE c")],2),", p=",
round(report_lmer$p[which(report_lmer$Parameter=="MRI AGE c")],3))

lmer_table[7,2] <- paste0("b=",round(report_lmer$Coefficient[which(report_lmer$Parameter=="Parent Alone num c")],2)," [",
round(report_lmer$CI_low[which(report_lmer$Parameter=="Parent Alone num c")],2), ",",
round(report_lmer$CI_high[which(report_lmer$Parameter=="Parent Alone num c")],2),"], ",
"B=",round(report_lmer$Std_Coefficient[which(report_lmer$Parameter=="Parent Alone num c")],2)," [",
round(report_lmer$Std_Coefficient_CI_low[which(report_lmer$Parameter=="Parent Alone num c")],2), ",",
round(report_lmer$Std_Coefficient_CI_high[which(report_lmer$Parameter=="Parent Alone num c")],2),"], t(",
report_lmer$df_error[1],")=",round(report_lmer$t[which(report_lmer$Parameter=="Parent Alone num c")],2),", p=",
round(report_lmer$p[which(report_lmer$Parameter=="Parent Alone num c")],3))

lmer_table[8,2] <- paste0("b=",round(report_lmer$Coefficient[which(report_lmer$Parameter=="Parent Alone num c * SEX num c")],2)," [",
round(report_lmer$CI_low[which(report_lmer$Parameter=="Parent Alone num c * SEX num c")],2), ",",
round(report_lmer$CI_high[which(report_lmer$Parameter=="Parent Alone num c * SEX num c")],2),"], ",
"B=",round(report_lmer$Std_Coefficient[which(report_lmer$Parameter=="Parent Alone num c * SEX num c")],2)," [",
round(report_lmer$Std_Coefficient_CI_low[which(report_lmer$Parameter=="Parent Alone num c * SEX num c")],2), ",",
round(report_lmer$Std_Coefficient_CI_high[which(report_lmer$Parameter=="Parent Alone num c * SEX num c")],2),"], t(",
report_lmer$df_error[1],")=",round(report_lmer$t[which(report_lmer$Parameter=="Parent Alone num c * SEX num c")],2),", p=",
round(report_lmer$p[which(report_lmer$Parameter=="Parent Alone num c * SEX num c")],3))

lmer_table[9,2] <- paste0("b=",round(report_lmer$Coefficient[which(report_lmer$Parameter=="Parent Alone num c * MRI AGE c")],2)," [",
round(report_lmer$CI_low[which(report_lmer$Parameter=="Parent Alone num c * MRI AGE c")],2), ",",
round(report_lmer$CI_high[which(report_lmer$Parameter=="Parent Alone num c * MRI AGE c")],2),"], ",
"B=",round(report_lmer$Std_Coefficient[which(report_lmer$Parameter=="Parent Alone num c * MRI AGE c")],2)," [",
round(report_lmer$Std_Coefficient_CI_low[which(report_lmer$Parameter=="Parent Alone num c * MRI AGE c")],2), ",",
round(report_lmer$Std_Coefficient_CI_high[which(report_lmer$Parameter=="Parent Alone num c * MRI AGE c")],2),"], t(",
report_lmer$df_error[1],")=",round(report_lmer$t[which(report_lmer$Parameter=="Parent Alone num c * MRI AGE c")],2),", p=",
round(report_lmer$p[which(report_lmer$Parameter=="Parent Alone num c * MRI AGE c")],3))

```

#organize files amygdala bilateral subnuclei: CS+ and CS- vs. baseline contrasts
#change each time to the ROI you want to check
```{r}
#contrast 1
DROI_amyg_plusmin_cond1 <- read.csv ("../data/ROI_thr60_supamyg_bilateral_plusminbase_cond1.csv")
valid_subj <- read.csv ("../data/valid_participant_list.csv")
DROI_amyg_plusmin_cond1$Subject <- rep(valid_subj$Subject, each=2)
DROI_amyg_plusmin_cond1$Subject <- as.numeric(gsub("sub-","",DROI_amyg_plusmin_cond1$Subject))
DROI_amyg_plusmin_cond1$contrast <- rep(c("plus_baseline","minus_baseline"),times=nrow(valid_subj))
DROI_amyg_plusmin_cond1 <- reshape(DROI_amyg_plusmin_cond1, timevar="contrast",idvar="Subject", direction="wide")
DROI_amyg_plusmin_cond1$order <- "cond1"

#contrast 2
DROI_amyg_plusmin_cond2 <- read.csv ("../data/ROI_thr60_supamyg_bilateral_plusminbase_cond2.csv")
DROI_amyg_plusmin_cond2$Subject <- rep(valid_subj$Subject, each=2)
DROI_amyg_plusmin_cond2$Subject <- as.numeric(gsub("sub-","",DROI_amyg_plusmin_cond2$Subject))
DROI_amyg_plusmin_cond2$contrast <- rep(c("plus_baseline","minus_baseline"),times=nrow(valid_subj))
DROI_amyg_plusmin_cond2 <- reshape(DROI_amyg_plusmin_cond2, timevar="contrast",idvar="Subject", direction="wide")
DROI_amyg_plusmin_cond2$order <- "cond2"

#combine conditions
DROI_amyg_plusmin <- rbind(DROI_amyg_plusmin_cond1,DROI_amyg_plusmin_cond2)

#merge with parent/alone version
DROI_amyg_plusmin <- merge(DROI_amyg_plusmin,DParentOrderLong, by=c("Subject","order"), all.x=T, all.y=F)

#combine the files 
DROI_amyg <- merge(DROI_amyg, DROI_amyg_plusmin[,c("Subject","Parent_Alone","amyg_activation.plus_baseline","amyg_activation.minus_baseline")], 
                            by =c("Subject","Parent_Alone"), all.x=T, all.y=T)

```

#organize files mPFC: CS+ and CS- vs. baseline contrasts
```{r}
#contrast 1
DROI_mPFC_plusmin_cond1 <- read.csv ("../data/ROI_BA102432_-20-10_plusmin_cond1.csv")
valid_subj <- read.csv ("../data/valid_participant_list.csv")
DROI_mPFC_plusmin_cond1$Subject <- rep(valid_subj$Subject, each=2)
DROI_mPFC_plusmin_cond1$Subject <- as.numeric(gsub("sub-","",DROI_mPFC_plusmin_cond1$Subject))
DROI_mPFC_plusmin_cond1$contrast <- rep(c("plus_baseline","minus_baseline"),times=nrow(valid_subj))
DROI_mPFC_plusmin_cond1 <- reshape(DROI_mPFC_plusmin_cond1, timevar="contrast",idvar="Subject", direction="wide")
DROI_mPFC_plusmin_cond1$order <- "cond1"

#contrast 2
DROI_mPFC_plusmin_cond2 <- read.csv ("../data/ROI_BA102432_-20-10_plusmin_cond2.csv")
DROI_mPFC_plusmin_cond2$Subject <- rep(valid_subj$Subject, each=2)
DROI_mPFC_plusmin_cond2$Subject <- as.numeric(gsub("sub-","",DROI_mPFC_plusmin_cond2$Subject))
DROI_mPFC_plusmin_cond2$contrast <- rep(c("plus_baseline","minus_baseline"),times=nrow(valid_subj))
DROI_mPFC_plusmin_cond2 <- reshape(DROI_mPFC_plusmin_cond2, timevar="contrast",idvar="Subject", direction="wide")
DROI_mPFC_plusmin_cond2$order <- "cond2"

#combine conditions
DROI_mPFC_plusmin <- rbind(DROI_mPFC_plusmin_cond1,DROI_mPFC_plusmin_cond2)

#merge with parent/alone version
DROI_mPFC_plusmin <- merge(DROI_mPFC_plusmin,DParentOrderLong, by=c("Subject","order"), all.x=T, all.y=F)

#combine the files 
DROI_mPFC <- merge(DROI_mPFC, DROI_mPFC_plusmin[,c("Subject","Parent_Alone","mPFC_activation.plus_baseline","mPFC_activation.minus_baseline")], 
                            by =c("Subject","Parent_Alone"), all.x=T, all.y=T)


#merge with sex and age
 DROI_mPFC_plusmin <- merge(DROI_mPFC_plusmin,DBehav_Wide[,c("Subject","SEX","MRI_AGE")],
                              by="Subject", all.x=T, all.y=F)
 
#turn to numeric and scale
#create age groups- divide the sample according to children (under 11) and adolescents (age cutoff according to gee 2014)
 DROI_mPFC_plusmin <- DROI_mPFC_plusmin %>%
    dplyr::mutate(SEX_num = ifelse(SEX=="m",0,1),
                  SEX_num_c = scale(SEX_num,scale=F),
                  Parent_Alone_num = ifelse(Parent_Alone=="Alone",0,1),
                  Parent_Alone_num_c = scale(Parent_Alone_num,scale=F),
                  MRI_AGE_c = scale(MRI_AGE, scale=F),
                  MRI_AGE_group = ifelse(MRI_AGE<11,"child","adolescent"),
                  order_num = ifelse(order=="cond1",0,1),
                  order_num_c = scale(order_num, scale=F))
```

#check correlations between the contrasts
```{r}
cor.test(DROI_amyg$amyg_activation.plus_minus,DROI_amyg$amyg_activation.plus_baseline)
cor.test(DROI_mPFC$mPFC_activation.plus_minus,DROI_mPFC$mPFC_activation.plus_baseline)
#sanity check- positive correlation between plus-minus and plus-baseline

cor.test(DROI_amyg$amyg_activation.plus_minus,DROI_amyg$amyg_activation.minus_baseline)
cor.test(DROI_mPFC$mPFC_activation.plus_minus,DROI_mPFC$mPFC_activation.minus_baseline)
#sanity check- negative correlation between plus-minus and minus-baseline

cor.test(DROI_amyg$amyg_activation.noise_baseline,DROI_amyg$amyg_activation.plus_baseline)
cor.test(DROI_mPFC$mPFC_activation.noise_baseline,DROI_mPFC$mPFC_activation.plus_baseline)
#more activation to noise- less activation to the CS+

cor.test(DROI_amyg$amyg_activation.noise_baseline,DROI_amyg$amyg_activation.minus_baseline)
cor.test(DROI_mPFC$mPFC_activation.noise_baseline,DROI_mPFC$mPFC_activation.minus_baseline)
#more activation to noise- more activation to the CS- 

cor.test(DROI_amyg$amyg_activation.noise_baseline,DROI_amyg$amyg_activation.plus_minus)
cor.test(DROI_mPFC$mPFC_activation.noise_baseline,DROI_mPFC$mPFC_activation.plus_minus)
#much more robust: more activation to noise- less differentiation between CS+ and CS-. Seems like it stems from both directions (i.e., both lower response to CS+ and higher response to CS-). Maybe indicates less learning in total?
#same pattern both when alone and when with parent

#visualize correlation- US vs. baseline and CS+ vs CS-
#change each time to the ROI you want to check
contrasts_cor_plot <- ggplot(DROI_mPFC, aes(x=mPFC_activation.noise_baseline, y=mPFC_activation.plus_minus)) +
    labs (x = "BOLD activation- US vs. baseline", y = "BOLD activation- CS+ vs. CS-)") +
    ylim(-1.5,1.5) +
    geom_point(size=5, color="blue") + 
    geom_smooth(method=lm, fullrange=TRUE, size=0.7, color="black", se=TRUE) +
    theme_classic() +
    theme(axis.text = element_text(size = 28), axis.title = element_text(size = 28)) 

#visualize correlation- US vs. baseline and CS+ vs. baseline
#change each time to the ROI you want to check
contrasts_cor_plot <- ggplot(DROI_mPFC, aes(x=mPFC_activation.noise_baseline, y=mPFC_activation.plus_baseline)) +
    labs (x = "BOLD activation- US vs. baseline", y = "BOLD activation- CS+ vs. baseline)") +
    ylim(-1.5,1.5) +
    geom_point(size=5, color="blue") + 
    geom_smooth(method=lm, fullrange=TRUE, size=0.7, color="black", se=TRUE) +
    theme_classic() +
    theme(axis.text = element_text(size = 28), axis.title = element_text(size = 28)) 

```

#organize file- irrelevant ROIs for checks (change the data file each time to the mask you want to check)
```{r}
#contrast 1
  DROI_primmotor_cond1 <- read.csv ("../data/ROI_primmotor_r_cond1.csv")
  valid_subj <- read.csv ("../data/valid_participant_list.csv")
  DROI_primmotor_cond1$Subject <- rep(valid_subj$Subject, each=2)
  DROI_primmotor_cond1$Subject <- as.numeric(gsub("sub-","",DROI_primmotor_cond1$Subject))
  DROI_primmotor_cond1$contrast <- rep(c("noise_baseline","plus_minus"),times=nrow(valid_subj))
  DROI_primmotor_cond1 <- reshape(DROI_primmotor_cond1, timevar="contrast",idvar="Subject", direction="wide")
  DROI_primmotor_cond1$order <- "cond1"

#contrast 2
  DROI_primmotor_cond2 <- read.csv ("../data/ROI_primmotor_r_cond2.csv")
  DROI_primmotor_cond2$Subject <- rep(valid_subj$Subject, each=2)
  DROI_primmotor_cond2$Subject <- as.numeric(gsub("sub-","",DROI_primmotor_cond2$Subject))
  DROI_primmotor_cond2$contrast <- rep(c("noise_baseline","plus_minus"),times=nrow(valid_subj))
  DROI_primmotor_cond2 <- reshape(DROI_primmotor_cond2, timevar="contrast",idvar="Subject", direction="wide")
  DROI_primmotor_cond2$order <- "cond2"

#combine conditions
  DROI_primmotor <- rbind(DROI_primmotor_cond1,DROI_primmotor_cond2)

#merge with parent/alone version
  DROI_primmotor <- merge(DROI_primmotor,DParentOrderLong, by=c("Subject","order"), all.x=T, all.y=F)

#merge with sex and age
  DROI_primmotor <- merge(DROI_primmotor,DBehav_Wide[,c("Subject","SEX","MRI_AGE")],
                              by="Subject", all.x=T, all.y=F)
 
#turn to numeric and scale
#create age groups- divide the sample according to children (under 11) and adolescents (age cutoff according to gee 2014)
   DROI_primmotor <- DROI_primmotor %>%
    dplyr::mutate(SEX_num = ifelse(SEX=="m",0,1),
                  SEX_num_c = scale(SEX_num,scale=F),
                  Parent_Alone_num = ifelse(Parent_Alone=="Alone",0,1),
                  Parent_Alone_num_c = scale(Parent_Alone_num,scale=F),
                  MRI_AGE_c = scale(MRI_AGE, scale=F),
                  MRI_AGE_group = ifelse(MRI_AGE<11,"child","adolescent"),
                  order_num = ifelse(order=="cond1",0,1),
                  order_num_c = scale(order_num,scale=F))

```

#checks - irrelevant ROIs
```{r}
#correlation between the contrasts
cor.test(DROI_primmotor$primmotor_activation.noise_baseline,DROI_primmotor$primmotor_activation.plus_minus)

#analysis with no confounding variables- US+ vs baseline
lmer_primmotor_noise_baseline<-lmer(data= DROI_primmotor, primmotor_activation.noise_baseline~Parent_Alone_num_c+(1|Subject))
report(lmer_primmotor_noise_baseline)

#analysis with no confounding variables- CS+ vs CS-
lmer_primmotor_plus_minus<-lmer(data= DROI_primmotor, primmotor_activation.plus_minus~Parent_Alone_num_c+(1|Subject))
report(lmer_primmotor_plus_minus)
```

